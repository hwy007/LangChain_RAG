# RAG系统前后端对接测试指南

## 前置条件

1. **启动后端服务**：确保后端服务运行在 `http://localhost:8002`
2. **准备测试文档**：准备一个或多个 `.md` 格式的测试文档

## API对接状态

### ✅ 已完成的功能

1. **文件上传接口** (`POST /api/upload`)
   - 前端组件：`FileUploadModal` - 上传步骤
   - 支持 `.md` 格式文件上传
   - 上传成功后显示文件名列表

2. **创建知识库接口** (`POST /api/kb/create`)
   - 前端组件：`FileUploadModal` - 配置步骤
   - 参数映射：
     - `kb_name` ← 数据库名称
     - `chunk_size` ← 分段最大长度 (默认2048)
     - `chunk_overlap` ← 重叠最大长度 (默认100)
     - `file_filenames` ← 上传的文件名列表
   - 创建成功后显示总片段数

3. **召回测试接口** (`POST /api/kb/recall`)
   - 前端组件：`KnowledgeBaseManager` - 召回测试区域
   - 参数映射：
     - `kb_name` ← 当前知识库名称
     - `query` ← 用户输入的测试查询
     - `top_k` ← 知识库配置的TopK值
   - 结果显示：
     - 文档片段内容（前100字符）
     - 相关性分数（L2距离转换为0-1分数）

4. **AI对话接口** (`POST /api/chat`)
   - 前端组件：`ChatInterface`
   - 参数映射：
     - `query` ← 用户消息
     - `kb_name` ← 当前关联的知识库名称（无知识库时为null）
     - `top_k` ← 知识库的TopK配置
   - 结果显示：
     - AI回答内容
     - 引用的文档片段（如果有）
     - 文档片段相关性分数

## 数据转换说明

### 相关性分数转换

后端返回的 `score` 是L2距离，越小表示越相似。前端使用以下公式转换为0-1之间的相关性分数：

```typescript
relevance = 1 / (1 + score)
```

- `score = 0` → `relevance = 1.00`（完全相关）
- `score = 0.45` → `relevance = 0.69`（高度相关）
- `score = 1` → `relevance = 0.50`（中度相关）
- `score = 4` → `relevance = 0.20`（低度相关）

### 参数名称映射

| 前端变量名 | 后端参数名 | 说明 |
|-----------|-----------|------|
| `dbName` | `kb_name` | 知识库名称 |
| `maxChunkSize` | `chunk_size` | 分段最大长度 |
| `maxOverlap` | `chunk_overlap` | 重叠最大长度 |
| `topK` | `top_k` | TopK值 |

## 测试流程

### 1. 测试文件上传和知识库创建

1. 点击"开始上传文档"按钮
2. 选择一个 `.md` 文件
3. 点击"下一步"，等待文件上传完成
4. 配置知识库参数（或使用默认值）
5. 点击"保存"，等待知识库创建完成
6. 查看成功提示和总片段数

**预期结果**：
- 文件上传成功提示
- 显示创建的片段总数
- 知识库信息显示在右侧面板

### 2. 测试召回功能

1. 在右侧"召回测试"输入框中输入查询问题
2. 点击搜索按钮或按回车
3. 查看返回的文档片段列表

**预期结果**：
- 显示 TopK 个相关文档片段
- 每个片段显示相关性分数（0-1之间）
- 片段内容截断显示（前100字符）
- 点击片段可查看完整内容

### 3. 测试AI对话

#### 3.1 关联知识库的对话

1. 确保已创建知识库
2. 在聊天框输入问题
3. 发送消息

**预期结果**：
- AI返回基于知识库的回答
- 显示引用的文档片段（如果有）
- 片段显示前20字符+点击展开

#### 3.2 无知识库的对话

1. 删除当前知识库（点击垃圾桶图标）
2. 在聊天框输入问题
3. 发送消息

**预期结果**：
- AI返回纯模型对话结果
- 不显示文档片段引用

## 错误处理

所有API调用都包含错误处理：

1. **网络错误**：显示toast错误提示
2. **服务器错误**：显示错误消息，记录到console
3. **上传失败**：在结果页面显示错误详情
4. **知识库创建失败**：在结果页面显示错误详情

## 调试建议

1. **打开浏览器开发者工具**：查看Network标签中的API请求和响应
2. **查看Console**：所有API错误都会记录到console
3. **查看Toast通知**：成功和失败都会有toast提示
4. **检查请求参数**：确保参数格式正确（特别是 `file_filenames` 数组）

## 已知限制

1. 前端仅支持单文件上传（虽然后端支持多文件）
2. 相关性分数转换公式假设L2距离不会过大（通常<10）
3. 无对话历史保存功能（清空对话仅清空前端状态）

## 下一步改进建议

1. 支持多文件批量上传
2. 添加知识库列表管理（当前只支持单个知识库）
3. 添加对话历史持久化
4. 优化相关性分数显示（可能需要根据实际数据调整转换公式）
5. 添加文件上传进度显示
